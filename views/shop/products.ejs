<!-- Category-wise Product Listing Page -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title %> - Online Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <%- include('../partials/navbar') %>

  <div class="container pt-5">
    <% categories.forEach(category => { 
         const productsInCategory = products.filter(p => p.category_name === category.name);
         if (productsInCategory.length > 0) {
    %>
      <section class="category-section mb-5 ">
        <h2 class="text-uppercase fw-bold mb-3"><%= category.name %></h2>
        <div class="bg-light py-3 rounded-5">
          <div class="category-products-row">
            <% productsInCategory.forEach(product => {
                 let currentPrice = parseFloat(product.discount_price) || parseFloat(product.price);
                 let originalPrice = parseFloat(product.price);
                 let discount = product.discount_price ? Math.round(((originalPrice - currentPrice) / originalPrice) * 100) : 0;
                 let rating = parseFloat(product.rating || (Math.random() * 1.0 + 4.0).toFixed(1));
                 let fullStars = Math.floor(rating);
                 let halfStar = rating % 1 >= 0.4 && rating % 1 < 0.9;
                 let emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            %>
              <div class="category-product-card-col">
                <a href="/products/<%= product.id %>" class="card text-decoration-none text-dark h-100">
                  <div class="position-relative" style="padding-top: 100%; overflow: hidden;">
                    <img src="<%= product.image_url || '/images/products/no-image.jpg' %>" alt="<%= product.name %>" class="position-absolute top-0 start-0 w-100 h-100" />
                  </div>
                  <div class="card-body d-flex flex-column font-jack-frost">
                    <h6 class="fw-bold text-uppercase mb-1"><%= product.name %></h6>

                    <div class="mb-2">
                      <% for (let i = 0; i < fullStars; i++) { %>
                        <i class="fas fa-star text-warning"></i>
                      <% } %>
                      <% if (halfStar) { %>
                        <i class="fas fa-star-half-alt text-warning"></i>
                      <% } %>
                      <% for (let i = 0; i < emptyStars; i++) { %>
                        <i class="far fa-star text-warning"></i>
                      <% } %>
                      <span class="ms-1 text-muted"><%= rating %>/5</span>
                    </div>

                    <div class="mt-auto">
                      <span class="current-price-new-arrival fw-bold">$<%= currentPrice.toFixed(0) %></span>
                      <% if (discount > 0) { %>
                        <span class="text-muted text-decoration-line-through ms-1">$<%= originalPrice.toFixed(0) %></span>
                        <span class="badge bg-danger ms-2">-<%= discount %>%</span>
                      <% } %>
                    </div>
                  </div>
                </a>
              </div>
            <% }); %>
          </div>
        </div>
      </section>
    <% }}); %>
  </div>

  <%- include('../partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
